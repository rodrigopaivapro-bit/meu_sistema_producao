{% extends 'base.html' %}
{% load static %}

{% block title %}PROPLAN SG{% endblock %}

{% block styles %}
<style>
    /* Estilos customizados para a página de produção */
    .btn { @apply text-white font-bold py-3 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed; }
    .btn-green { @apply bg-green-600 hover:bg-green-700; }
    .btn-blue { @apply bg-blue-600 hover:bg-blue-700; }
    .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-600; }
    .btn-red { @apply bg-red-600 hover:bg-red-700; }
    .progress-bar-fill {
        transition: width 0.5s ease-in-out;
    }
    .toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2d3748; /* bg-gray-800 */
…        opacity: 1;
        bottom: 40px;
    }
</style>
{% endblock %}


{% block content %}
    <div class="container mx-auto p-4 md:p-8">
        <!-- Cabeçalho -->
        <header class="bg-gray-800 rounded-xl shadow-2xl p-6 mb-6 border border-gray-700 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-blue-400">Terminal de Produção</h1>
                <p id="machine-selection-text" class="text-gray-400 text-lg">Selecione uma máquina para começar</p>
            </div>
             <a href="{% url 'menu' %}" 
               class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-home"></i> 
                <span>Voltar ao Menu</span>
            </a>
        </header>

        <!-- Seleção de Máquinas -->
        <div class="mb-6 bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <div id="machine-selector" class="flex flex-wrap gap-4">
                {% for maquina in maquinas %}
                    <button class="bg-gray-700 hover:bg-blue-600 text-gray-100 font-bold py-2 px-4 rounded-lg transition-colors text-lg" data-maquina-id="{{ maquina.id }}">
                        {{ maquina.number }}
                    </button>
                {% endfor %}
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <main id="production-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna da OP Atual -->
            <div class="lg:col-span-2 bg-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700">
                <h2 class="text-3xl font-bold text-blue-400 border-b border-gray-600 pb-4 mb-6">Ordem em Produção</h2>
                <div id="current-op-card" class="space-y-6">
                    <!-- Conteúdo dinâmico da OP em produção -->
                     <div class="text-center py-10 text-gray-500">Nenhuma OP em produção. Inicie a próxima OP.</div>
                </div>
            </div>

            <!-- Coluna da Próxima OP e Ações -->
            <div class="space-y-8">
                <div class="bg-gray-800 rounded-xl shadow-2xl p-6 border border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-300 border-b border-gray-600 pb-3 mb-4">Próxima Ordem</h2>
                    <div id="next-op-card" class="space-y-2">
                         <!-- Conteúdo dinâmico da próxima OP -->
                         <div class="text-center py-4 text-gray-500">Nenhuma OP planejada.</div>
                    </div>
                </div>
                 <div class="bg-gray-800 rounded-xl shadow-2xl p-6 border border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-300 border-b border-gray-600 pb-3 mb-4">Ações</h2>
                     <div class="space-y-4">
                        <button id="btn-start" class="btn btn-green w-full text-xl"><i class="fas fa-play mr-2"></i> Iniciar OP</button>
                        <button id="btn-report" class="btn btn-blue w-full text-xl"><i class="fas fa-check-double mr-2"></i> Apontar Produção</button>
                        <button id="btn-stop" class="btn btn-yellow w-full text-xl"><i class="fas fa-pause-circle mr-2"></i> Registrar Parada</button>
                        <button id="btn-finish" class="btn btn-red w-full text-xl"><i class="fas fa-flag-checkered mr-2"></i> Finalizar OP</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Apontamento -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-8 border border-gray-700 shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold text-blue-400 mb-6">Apontar Quantidade Produzida</h3>
            <div class="space-y-4">
                <label for="quantity-input" class="block text-lg text-gray-300">Quantidade Produzida:</label>
                <input type="number" id="quantity-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-2xl text-white text-center focus:outline-none focus:border-blue-500">
            </div>
            <div class="flex gap-4 mt-8">
                <button id="cancel-report" class="btn bg-gray-600 hover:bg-gray-500 w-full">Cancelar</button>
                <button id="confirm-report" class="btn btn-blue w-full">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Parada -->
    <div id="stopModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-8 border border-gray-700 shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold text-yellow-400 mb-6">Registrar Parada de Máquina</h3>
            <div class="space-y-6">
                <div>
                    <label for="stop-reason-select" class="block text-lg text-gray-300 mb-2">Motivo da Parada:</label>
                    <select id="stop-reason-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-lg text-white focus:outline-none focus:border-blue-500">
                        <option value="">Carregando motivos...</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="parada-inicio-input" class="block text-lg text-gray-300 mb-2">Início da Parada:</label>
                        <input type="datetime-local" id="parada-inicio-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-lg text-white focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label for="parada-fim-input" class="block text-lg text-gray-300 mb-2">Fim da Parada:</label>
                        <input type="datetime-local" id="parada-fim-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-lg text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button id="cancel-stop" class="btn bg-gray-600 hover:bg-gray-500 w-full">Cancelar</button>
                <button id="confirm-stop" class="btn btn-yellow w-full">Confirmar Parada</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Estado da aplicação
    let selectedMachineId = null;
    let currentOp = null;
    let nextOp = null;

    // Elementos do DOM
    const machineSelector = document.getElementById('machine-selector');
    const machineSelectionText = document.getElementById('machine-selection-text');
    const productionContent = document.getElementById('production-content');
    const currentOpCard = document.getElementById('current-op-card');
    const nextOpCard = document.getElementById('next-op-card');

    // Botões de Ação
    const btnStart = document.getElementById('btn-start');
    const btnReport = document.getElementById('btn-report');
    const btnStop = document.getElementById('btn-stop');
    const btnFinish = document.getElementById('btn-finish');

    // Modal de Apontamento
    const reportModal = document.getElementById('reportModal');
    const quantityInput = document.getElementById('quantity-input');
    const cancelReportBtn = document.getElementById('cancel-report');
    const confirmReportBtn = document.getElementById('confirm-report');

    // Modal de Parada
    const stopModal = document.getElementById('stopModal');
    const stopReasonSelect = document.getElementById('stop-reason-select');
    const paradaInicioInput = document.getElementById('parada-inicio-input');
    const paradaFimInput = document.getElementById('parada-fim-input');
    const cancelStopBtn = document.getElementById('cancel-stop');
    const confirmStopBtn = document.getElementById('confirm-stop');
    const csrfToken = '{{ csrf_token }}';

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.body.appendChild(toast);

        // Mostra o toast com uma pequena animação
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        // Esconde e remove o toast depois de 3 segundos
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500); // Espera a transição de fade-out terminar
        }, 3000);
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO ---
    function renderCurrentOp() {
        if (currentOp) {
            const percentage = (currentOp.quantidade_produzida / currentOp.quantidade_total) * 100;
            
            currentOpCard.innerHTML = `
                <!-- Bloco de Identificação Principal -->
                <div class="text-center mb-6">
                    <span class="text-5xl font-bold text-white">OP-${currentOp.op_id}</span>
                    <p class="text-2xl text-gray-400">${currentOp.pn_code} - ${currentOp.description || 'Sem descrição'}</p>
                </div>

                <!-- Bloco de Detalhes Técnicos em Grade -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center border-t border-b border-gray-700 py-6 mb-6">
                    <div>
                        <p class="text-sm text-gray-400 font-semibold uppercase">Capacidade</p>
                        <p class="text-2xl font-bold text-white">${currentOp.capacity_liters || 'N/A'} L</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 font-semibold uppercase">Tempo de Ciclo</p>
                        <p class="text-2xl font-bold text-white">${currentOp.cycle_time_seconds || 'N/A'} s</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 font-semibold uppercase">Peso Solda</p>
                        <p class="text-2xl font-bold text-white">${currentOp.sold_weight_kg || 'N/A'} kg</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 font-semibold uppercase">Peso Mínimo</p>
                        <p class="text-2xl font-bold text-white">${currentOp.min_weight_kg || 'N/A'} kg</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 font-semibold uppercase">Peso Máximo</p>
                        <p class="text-2xl font-bold text-white">${currentOp.max_weight_kg || 'N/A'} kg</p>
                    </div>
                     <div>
                        <p class="text-sm text-gray-400 font-semibold uppercase">Status</p>
                        <p class="text-2xl font-bold text-white">${currentOp.status || 'N/A'}</p>
                    </div>
                </div>

                <!-- Bloco de Progresso -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-lg font-semibold text-gray-300">Progresso:</span>
                        <span class="text-2xl font-bold text-blue-300">
                            ${currentOp.quantidade_produzida} / ${currentOp.quantidade_total}
                        </span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-8 border-2 border-gray-600">
                        <div class="bg-blue-600 h-full rounded-full progress-bar-fill" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="text-center mt-2 text-3xl font-bold text-white">${percentage.toFixed(1)}%</div>
                </div>
            `;
        } else {
            currentOpCard.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhuma OP em produção. Inicie a próxima OP.</div>`;
        }
    }

    function renderNextOp() {
        if (nextOp) {
            nextOpCard.innerHTML = `
                <p class="text-xl font-bold text-white">OP-${nextOp.op_id}</p>
                <p class="text-md text-gray-400">${nextOp.pn_code}</p>
                <p class="text-md text-gray-400">${nextOp.quantidade_total} unidades</p>
            `;
        } else {
            nextOpCard.innerHTML = `<div class="text-center py-4 text-gray-500">Nenhuma OP planejada.</div>`;
        }
    }

    function updateButtonStates() {
        btnStart.disabled = !nextOp || !!currentOp;
        btnReport.disabled = !currentOp;
        btnStop.disabled = !currentOp;
        btnFinish.disabled = !currentOp;
    }

    // --- LÓGICA PRINCIPAL ---
    async function fetchMachineData(machineId) {
        if (!machineId) return;
        try {
            const response = await fetch(`{% url 'get_dados_maquina_api' %}?maquina_id=${machineId}`);
            if (!response.ok) throw new Error('Falha ao buscar dados da máquina.');
            const data = await response.json();
            
            currentOp = data.op_em_producao;
            nextOp = data.proxima_op;
            
            renderCurrentOp();
            renderNextOp();
            updateButtonStates();

        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    machineSelector.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (target) {
            selectedMachineId = target.dataset.maquinaId;
            document.querySelectorAll('#machine-selector button').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            target.classList.add('bg-blue-600');
            target.classList.remove('bg-gray-700');
            
            machineSelectionText.textContent = `Visualizando: Máquina ${target.textContent.trim()}`;
            productionContent.classList.remove('hidden');
            fetchMachineData(selectedMachineId);
        }
    });

    // --- LÓGICA DOS BOTÕES DE AÇÃO ---
    btnStart.addEventListener('click', async () => {
        if (!nextOp) return;
        try {
            const response = await fetch(`{% url 'iniciar_op_api' %}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ op_id: nextOp.op_id })
            });
            if (!response.ok) throw new Error('Falha ao iniciar OP.');
            await fetchMachineData(selectedMachineId);
        } catch (error) { console.error(error); alert(error.message); }
    });

    btnFinish.addEventListener('click', async () => {
        if (!currentOp) return;
        if (!confirm(`Tem certeza que deseja finalizar a OP-${currentOp.op_id}?`)) return;
        try {
            const response = await fetch(`{% url 'finalizar_op_api' %}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ op_id: currentOp.op_id })
            });
            if (!response.ok) throw new Error('Falha ao finalizar OP.');
            await fetchMachineData(selectedMachineId);
        } catch (error) { console.error(error); alert(error.message); }
    });

    // --- LÓGICA DOS MODAIS ---
    btnReport.addEventListener('click', () => {
        quantityInput.value = '';
        reportModal.classList.remove('hidden');
        reportModal.classList.add('flex');
        quantityInput.focus();
    });
    cancelReportBtn.addEventListener('click', () => reportModal.classList.add('hidden'));
    confirmReportBtn.addEventListener('click', async () => {
        const quantidade = quantityInput.value;
        if (!quantidade || quantidade <= 0) {
            alert('Por favor, insira uma quantidade válida.');
            return;
        }
        try {
            const response = await fetch(`{% url 'apontar_producao_api' %}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ agendamento_id: currentOp.agendamento_id, quantidade: quantidade })
            });
             if (!response.ok) throw new Error('Falha ao apontar produção.');
            const data = await response.json();
            
            if (currentOp) {
                currentOp.quantidade_produzida = data.nova_quantidade_produzida;
                renderCurrentOp();
                updateButtonStates();
            }
            reportModal.classList.add('hidden');

        } catch (error) { console.error(error); alert(error.message); }
    });
    
    btnStop.addEventListener('click', async () => {
        // Limpa e prepara o select
        stopReasonSelect.innerHTML = '<option value="">Carregando motivos...</option>';
        paradaInicioInput.value = '';
        paradaFimInput.value = '';
        stopReasonSelect.disabled = true;

        // Mostra o modal
        stopModal.classList.remove('hidden');
        stopModal.classList.add('flex');

        // Busca os tipos de parada na nova API
        try {
            const response = await fetch(`{% url 'get_tipos_parada_api' %}`);
            if (!response.ok) throw new Error('Falha ao carregar motivos.');
            const tiposParada = await response.json();

            // Popula o select com as opções
            stopReasonSelect.innerHTML = '<option value="">-- Selecione um motivo --</option>';
            tiposParada.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id;
                option.textContent = `${tipo.codigo} - ${tipo.descricao}`;
                stopReasonSelect.appendChild(option);
            });
            stopReasonSelect.disabled = false;

        } catch (error) {
            console.error(error);
            stopReasonSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    });

    cancelStopBtn.addEventListener('click', () => stopModal.classList.add('hidden'));   

    confirmStopBtn.addEventListener('click', async () => {
        const tipoParadaId = stopReasonSelect.value;
        const inicioParada = paradaInicioInput.value;
        const fimParada = paradaFimInput.value;
        if (!tipoParadaId || !inicioParada || !fimParada) {
            alert('Todos os campos são obrigatórios.');
            return;
        }
        if (new Date(fimParada) <= new Date(inicioParada)) {
            alert('O horário de fim deve ser posterior ao de início.');
            return;
        }

         try {
            const response = await fetch(`{% url 'registrar_parada_api' %}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ 
                    agendamento_id: currentOp.agendamento_id, 
                    tipo_parada_id: tipoParadaId,
                    inicio_parada: inicioParada,
                    fim_parada: fimParada
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.mensagem || 'Falha ao registrar parada.');
            }
            
            showToast('Parada registrada com sucesso!');
            stopModal.classList.add('hidden');

        } catch (error) { 
            console.error(error); 
            alert(error.message); 
        }
    });
});
</script>
{% endblock %}